<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>币安实时异动监控系统</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #1e3a8a;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --info-color: #3b82f6;
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --text-color: #f1f5f9;
            --border-color: #334155;
            --table-header: #475569;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        
        h1 {
            color: var(--primary-color);
            margin-bottom: 10px;
            font-size: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .subtitle {
            color: #94a3b8;
            font-size: 1.1rem;
        }
        
        .status-bar {
            display: flex;
            justify-content: space-between;
            background: var(--card-bg);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
        }
        
        .status-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .status-value {
            font-size: 1.8rem;
            font-weight: bold;
            margin-top: 5px;
        }
        
        .status-label {
            color: #94a3b8;
            font-size: 0.9rem;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(500px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid var(--border-color);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .card-title {
            font-size: 1.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .pair-management {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
        }
        
        input {
            flex: 1;
            padding: 14px 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-color);
            font-size: 1rem;
        }
        
        button {
            padding: 14px 25px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        button:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background: var(--danger-color);
        }
        
        .btn-success {
            background: var(--success-color);
        }
        
        .btn-warning {
            background: var(--warning-color);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th {
            background: var(--table-header);
            padding: 18px 15px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid var(--border-color);
        }
        
        td {
            padding: 18px 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .change-positive {
            color: var(--success-color);
            font-weight: bold;
        }
        
        .change-negative {
            color: var(--danger-color);
            font-weight: bold;
        }
        
        .indicator {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .indicator.buy {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success-color);
        }
        
        .indicator.sell {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger-color);
        }
        
        .indicator.neutral {
            background: rgba(59, 130, 246, 0.2);
            color: var(--info-color);
        }
        
        .indicator.accumulation {
            background: rgba(16, 185, 129, 0.3);
            color: var(--success-color);
        }
        
        .indicator.distribution {
            background: rgba(239, 68, 68, 0.3);
            color: var(--danger-color);
        }
        
        .indicator.volume-spike {
            background: rgba(245, 158, 11, 0.3);
            color: var(--warning-color);
        }
        
        .timeframe-tabs {
            display: flex;
            margin-bottom: 25px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .timeframe-tab {
            padding: 12px 25px;
            cursor: pointer;
            font-weight: 600;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .timeframe-tab.active {
            border-bottom-color: var(--primary-color);
            color: var(--primary-color);
        }
        
        .chart-container {
            height: 350px;
            margin-top: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
        }
        
        .suggestion-card {
            background: linear-gradient(135deg, rgba(30, 58, 138, 0.3), rgba(30, 58, 138, 0.1));
            border-left: 5px solid var(--primary-color);
        }
        
        .suggestion-content {
            margin-top: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        
        .suggestion-item {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px dashed var(--border-color);
        }
        
        .suggestion-item:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        
        .last-update {
            text-align: center;
            color: #94a3b8;
            margin-top: 30px;
            font-size: 0.9rem;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
        }
        
        .action-btn {
            padding: 8px 15px;
            font-size: 0.9rem;
        }
        
        .pair-list {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
        }
        
        .websocket-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .websocket-status.connected {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success-color);
        }
        
        .websocket-status.connecting {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning-color);
        }
        
        .websocket-status.disconnected {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger-color);
        }
        
        .alert-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            margin-left: 8px;
            font-weight: 600;
        }
        
        .alert-badge.high {
            background: rgba(239, 68, 68, 0.3);
            color: var(--danger-color);
        }
        
        .alert-badge.medium {
            background: rgba(245, 158, 11, 0.3);
            color: var(--warning-color);
        }
        
        .alert-badge.low {
            background: rgba(59, 130, 246, 0.3);
            color: var(--info-color);
        }
        
        .data-source {
            font-size: 0.8rem;
            color: #64748b;
            margin-top: 5px;
            display: block;
        }
        
        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--danger-color);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            color: var(--danger-color);
        }
        
        @media (max-width: 1200px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .pair-management {
                flex-direction: column;
            }
            
            .status-bar {
                flex-wrap: wrap;
                gap: 20px;
            }
            
            .timeframe-tabs {
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-chart-line"></i> 币安实时异动监控系统</h1>
            <p class="subtitle">真实数据 | 多周期监控 | WebSocket实时更新 | 支持自定义交易对</p>
            <p class="data-source">数据源：币安WebSocket API + CoinGecko API备用方案</p>
        </header>
        
        <div class="status-bar">
            <div class="status-item">
                <span class="status-label">监控交易对</span>
                <span class="status-value" id="total-pairs">0</span>
            </div>
            <div class="status-item">
                <span class="status-label">活跃异动</span>
                <span class="status-value" id="active-alerts">0</span>
            </div>
            <div class="status-item">
                <span class="status-label">连接状态</span>
                <span class="websocket-status connecting" id="connection-status">
                    <i class="fas fa-sync fa-spin"></i> 连接中...
                </span>
            </div>
            <div class="status-item">
                <span class="status-label">最后更新</span>
                <span class="status-value" id="last-update-time">--:--:--</span>
            </div>
        </div>
        
        <div id="error-container"></div>
        
        <div class="grid">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title"><i class="fas fa-coins"></i> 交易对管理</h2>
                </div>
                
                <div class="pair-management">
                    <input type="text" id="pair-input" placeholder="输入交易对 (如: BTCUSDT, ETHUSDT)">
                    <button id="add-pair-btn" class="btn-success"><i class="fas fa-plus"></i> 添加</button>
                    <button id="reset-pairs-btn" class="btn-warning"><i class="fas fa-redo"></i> 重置</button>
                </div>
                
                <div class="pair-list">
                    <table id="pairs-table">
                        <thead>
                            <tr>
                                <th>交易对</th>
                                <th>当前价格</th>
                                <th>24h变化</th>
                                <th>状态</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="pairs-table-body">
                            <!-- 动态生成交易对行 -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title"><i class="fas fa-bell"></i> 实时异动监控</h2>
                    <div class="timeframe-tabs">
                        <div class="timeframe-tab active" data-timeframe="1m">1分钟</div>
                        <div class="timeframe-tab" data-timeframe="5m">5分钟</div>
                        <div class="timeframe-tab" data-timeframe="15m">15分钟</div>
                        <div class="timeframe-tab" data-timeframe="30m">30分钟</div>
                    </div>
                </div>
                
                <div id="alerts-container">
                    <table>
                        <thead>
                            <tr>
                                <th>交易对</th>
                                <th>周期</th>
                                <th>价格变化</th>
                                <th>异动类型</th>
                                <th>强度</th>
                                <th>时间</th>
                            </tr>
                        </thead>
                        <tbody id="alerts-table-body">
                            <!-- 动态生成异动行 -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title"><i class="fas fa-chart-bar"></i> 价格走势</h2>
                    <div class="action-buttons">
                        <button id="refresh-data-btn" class="action-btn"><i class="fas fa-sync-alt"></i> 刷新数据</button>
                    </div>
                </div>
                
                <div class="chart-container" id="price-chart">
                    <div id="chart-placeholder">
                        <i class="fas fa-chart-line" style="font-size: 3rem; color: #475569;"></i>
                        <p style="margin-top: 15px; color: #64748b;">价格图表加载中...</p>
                    </div>
                </div>
            </div>
            
            <div class="card suggestion-card">
                <div class="card-header">
                    <h2 class="card-title"><i class="fas fa-lightbulb"></i> 交易建议与信号</h2>
                    <div class="action-buttons">
                        <button id="refresh-suggestions-btn" class="action-btn"><i class="fas fa-sync-alt"></i> 刷新建议</button>
                    </div>
                </div>
                
                <div class="suggestion-content" id="suggestions-content">
                    <div class="suggestion-item">
                        <strong>系统启动中...</strong> 正在连接币安WebSocket获取实时数据。
                    </div>
                </div>
            </div>
        </div>
        
        <div class="last-update">
            <p>数据来源：币安WebSocket API + CoinGecko备用API | 系统自动更新</p>
            <p style="margin-top: 10px; font-size: 0.8rem;">
                <i class="fas fa-info-circle"></i> 提示：系统完全运行在浏览器中，所有数据均为实时市场数据
            </p>
        </div>
    </div>

    <script>
        // 全局变量
        let monitoredPairs = [];
        let priceData = {};
        let alertData = [];
        let activeTimeframe = '1m';
        let wsConnection = null;
        let alertHistory = [];
        let lastPriceData = {};
        
        // 数据源配置 - 使用多个备用数据源
        const DATA_SOURCES = {
            // 主数据源：币安WebSocket (无CORS限制)
            BINANCE_WS: 'wss://stream.binance.com:9443/ws',
            
            // 备用数据源：公共API代理 (解决CORS问题)
            COINGECKO: 'https://api.coingecko.com/api/v3',
            
            // 备用数据源：第三方币安数据API
            BINANCE_PROXY: 'https://api.binance.com/api/v3'
        };
        
        // 从localStorage加载交易对
        function loadPairsFromStorage() {
            try {
                const savedPairs = localStorage.getItem('binanceRealPairs');
                if (savedPairs) {
                    monitoredPairs = JSON.parse(savedPairs);
                } else {
                    // 默认交易对
                    monitoredPairs = ['BTCUSDT', 'ETHUSDT', 'BNBUSDT', 'SOLUSDT', 'ADAUSDT', 'XRPUSDT'];
                    savePairsToStorage();
                }
            } catch (e) {
                console.error('加载交易对失败:', e);
                monitoredPairs = ['BTCUSDT', 'ETHUSDT', 'BNBUSDT'];
            }
        }
        
        // 保存交易对到localStorage
        function savePairsToStorage() {
            localStorage.setItem('binanceRealPairs', JSON.stringify(monitoredPairs));
        }
        
        // 初始化页面
        async function initPage() {
            loadPairsFromStorage();
            setupEventListeners();
            setupTimeframeTabs();
            updateStatusDisplay();
            
            // 显示初始交易对表格
            renderPairsTable();
            
            // 连接到币安WebSocket
            connectToBinanceWebSocket();
            
            // 初始加载数据
            await loadInitialData();
            
            // 初始建议
            updateSuggestions();
            
            // 启动定时更新
            startUpdateTimer();
        }
        
        // 设置事件监听器
        function setupEventListeners() {
            // 添加交易对按钮
            document.getElementById('add-pair-btn').addEventListener('click', addNewPair);
            
            // 输入框回车键添加
            document.getElementById('pair-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addNewPair();
                }
            });
            
            // 重置交易对按钮
            document.getElementById('reset-pairs-btn').addEventListener('click', function() {
                if (confirm('确定要重置为默认交易对吗？')) {
                    monitoredPairs = ['BTCUSDT', 'ETHUSDT', 'BNBUSDT', 'SOLUSDT', 'ADAUSDT', 'XRPUSDT'];
                    savePairsToStorage();
                    renderPairsTable();
                    alertData = [];
                    renderAlertsTable();
                    updateSuggestions();
                    showNotification('已重置为默认交易对');
                }
            });
            
            // 刷新数据按钮
            document.getElementById('refresh-data-btn').addEventListener('click', async function() {
                showNotification('正在刷新数据...');
                await loadInitialData();
            });
            
            // 刷新建议按钮
            document.getElementById('refresh-suggestions-btn').addEventListener('click', updateSuggestions);
        }
        
        // 设置时间周期标签页
        function setupTimeframeTabs() {
            document.querySelectorAll('.timeframe-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    // 移除所有active类
                    document.querySelectorAll('.timeframe-tab').forEach(t => {
                        t.classList.remove('active');
                    });
                    
                    // 为当前标签添加active类
                    this.classList.add('active');
                    activeTimeframe = this.getAttribute('data-timeframe');
                    
                    // 更新异动表格
                    renderAlertsTable();
                });
            });
        }
        
        // 添加新交易对
        async function addNewPair() {
            const input = document.getElementById('pair-input');
            const pair = input.value.trim().toUpperCase().replace('/', '');
            
            if (!pair) {
                showError('请输入交易对！');
                return;
            }
            
            // 验证交易对格式
            if (!/^[A-Z]{3,10}[A-Z]{3,10}$/.test(pair)) {
                showError('交易对格式不正确！请使用类似 BTCUSDT 的格式。');
                return;
            }
            
            // 检查是否已存在
            if (monitoredPairs.includes(pair)) {
                showError('该交易对已在监控列表中！');
                return;
            }
            
            // 添加到监控列表
            monitoredPairs.push(pair);
            savePairsToStorage();
            
            // 清空输入框
            input.value = '';
            
            // 加载该交易对数据
            await loadPairData(pair);
            
            // 更新界面
            renderPairsTable();
            updateSuggestions();
            
            // 重新连接WebSocket以包含新交易对
            reconnectWebSocket();
            
            // 显示成功消息
            showNotification(`成功添加交易对: ${pair}`);
        }
        
        // 移除交易对
        function removePair(pair) {
            const index = monitoredPairs.indexOf(pair);
            if (index !== -1) {
                monitoredPairs.splice(index, 1);
                savePairsToStorage();
                
                // 从priceData中移除
                delete priceData[pair];
                delete lastPriceData[pair];
                
                // 从alertData中移除相关异动
                alertData = alertData.filter(alert => alert.pair !== pair);
                
                // 更新界面
                renderPairsTable();
                renderAlertsTable();
                updateSuggestions();
                updateStatusDisplay();
                
                // 重新连接WebSocket以移除交易对
                reconnectWebSocket();
                
                // 显示通知
                showNotification(`已移除交易对: ${pair}`);
            }
        }
        
        // 连接到币安WebSocket
        function connectToBinanceWebSocket() {
            try {
                // 如果已有连接，先关闭
                if (wsConnection) {
                    wsConnection.close();
                }
                
                // 创建WebSocket连接
                // 币安WebSocket支持多流订阅
                const streams = monitoredPairs.map(pair => `${pair.toLowerCase()}@ticker`).join('/');
                const wsUrl = `${DATA_SOURCES.BINANCE_WS}/stream?streams=${streams}`;
                
                wsConnection = new WebSocket(wsUrl);
                
                wsConnection.onopen = () => {
                    console.log('币安WebSocket连接已建立');
                    updateConnectionStatus('connected', '已连接');
                    clearError();
                    showNotification('实时数据连接已建立');
                };
                
                wsConnection.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    
                    // 处理ticker数据
                    if (data.data) {
                        const ticker = data.data;
                        const pair = ticker.s;
                        
                        // 计算价格变化
                        let priceChangePercent = 0;
                        if (lastPriceData[pair]) {
                            const lastPrice = lastPriceData[pair];
                            const currentPrice = parseFloat(ticker.c);
                            priceChangePercent = ((currentPrice - lastPrice) / lastPrice) * 100;
                        }
                        
                        // 保存最后价格
                        lastPriceData[pair] = parseFloat(ticker.c);
                        
                        // 更新价格数据
                        priceData[pair] = {
                            symbol: pair,
                            price: parseFloat(ticker.c).toFixed(4),
                            high: parseFloat(ticker.h).toFixed(4),
                            low: parseFloat(ticker.l).toFixed(4),
                            change24h: parseFloat(ticker.P).toFixed(2),
                            volume: formatVolume(parseFloat(ticker.v)),
                            quoteVolume: formatVolume(parseFloat(ticker.q)),
                            timestamp: new Date().getTime(),
                            priceChange: priceChangePercent.toFixed(2)
                        };
                        
                        // 检查价格异动
                        checkPriceAlert(pair, parseFloat(ticker.c), priceChangePercent, parseFloat(ticker.v));
                        
                        // 更新界面
                        renderPairsTable();
                        updateStatusDisplay();
                        updateLastUpdateTime();
                    }
                };
                
                wsConnection.onerror = (error) => {
                    console.error('WebSocket错误:', error);
                    updateConnectionStatus('disconnected', '连接错误');
                    showError('WebSocket连接错误，尝试使用备用数据源...');
                    
                    // 尝试使用备用数据源
                    setTimeout(() => loadInitialData(), 2000);
                };
                
                wsConnection.onclose = () => {
                    console.log('WebSocket连接关闭');
                    updateConnectionStatus('disconnected', '连接断开');
                    
                    // 5秒后尝试重连
                    setTimeout(() => connectToBinanceWebSocket(), 5000);
                };
                
            } catch (error) {
                console.error('连接WebSocket失败:', error);
                showError('无法连接WebSocket，使用备用数据源');
                updateConnectionStatus('disconnected', '连接失败');
                
                // 使用备用数据源
                loadInitialData();
            }
        }
        
        // 重新连接WebSocket
        function reconnectWebSocket() {
            if (wsConnection && wsConnection.readyState === WebSocket.OPEN) {
                wsConnection.close();
            }
            
            // 短暂延迟后重新连接
            setTimeout(() => connectToBinanceWebSocket(), 1000);
        }
        
        // 检查价格异动
        function checkPriceAlert(pair, currentPrice, priceChangePercent, volume) {
            // 记录异动阈值
            const alertThresholds = {
                '1m': { price: 1.0, volume: 3.0 },
                '5m': { price: 2.5, volume: 5.0 },
                '15m': { price: 4.0, volume: 8.0 },
                '30m': { price: 6.0, volume: 10.0 }
            };
            
            const threshold = alertThresholds[activeTimeframe] || alertThresholds['1m'];
            
            // 检测大涨
            if (priceChangePercent > threshold.price) {
                const alert = {
                    pair: pair,
                    timeframe: activeTimeframe,
                    priceChange: priceChangePercent.toFixed(2),
                    type: 'buy',
                    strength: Math.min(priceChangePercent / 10, 1),
                    timestamp: new Date().getTime(),
                    time: new Date().toLocaleTimeString('zh-CN', { hour12: false }),
                    description: `${activeTimeframe}上涨${priceChangePercent.toFixed(1)}%`
                };
                
                addAlert(alert);
            }
            
            // 检测大跌
            if (priceChangePercent < -threshold.price) {
                const alert = {
                    pair: pair,
                    timeframe: activeTimeframe,
                    priceChange: priceChangePercent.toFixed(2),
                    type: 'sell',
                    strength: Math.min(Math.abs(priceChangePercent) / 10, 1),
                    timestamp: new Date().getTime(),
                    time: new Date().toLocaleTimeString('zh-CN', { hour12: false }),
                    description: `${activeTimeframe}下跌${Math.abs(priceChangePercent).toFixed(1)}%`
                };
                
                addAlert(alert);
            }
        }
        
        // 添加异动
        function addAlert(alert) {
            // 避免重复添加相同异动
            const recentAlert = alertData.find(a => 
                a.pair === alert.pair && 
                a.timeframe === alert.timeframe &&
                Math.abs(a.timestamp - alert.timestamp) < 60000 // 1分钟内
            );
            
            if (!recentAlert) {
                alertData.unshift(alert);
                
                // 限制异动数量
                if (alertData.length > 50) {
                    alertData = alertData.slice(0, 50);
                }
                
                // 添加到历史记录
                alertHistory.unshift({
                    ...alert,
                    time: new Date().toLocaleTimeString('zh-CN', { hour12: false })
                });
                
                if (alertHistory.length > 100) {
                    alertHistory = alertHistory.slice(0, 100);
                }
                
                // 更新界面
                renderAlertsTable();
                updateStatusDisplay();
                
                // 显示通知（只显示高强度异动）
                if (alert.strength > 0.7) {
                    showNotification(`${alert.pair}: ${alert.description}`);
                }
            }
        }
        
        // 加载初始数据
        async function loadInitialData() {
            updateConnectionStatus('connecting', '获取数据中...');
            
            // 如果没有交易对，显示提示
            if (monitoredPairs.length === 0) {
                updateConnectionStatus('disconnected', '无交易对');
                return;
            }
            
            // 分批加载数据，避免请求过多
            const batchSize = 3;
            for (let i = 0; i < monitoredPairs.length; i += batchSize) {
                const batch = monitoredPairs.slice(i, i + batchSize);
                
                try {
                    await Promise.all(batch.map(pair => loadPairDataFromAlternative(pair)));
                    
                    // 更新界面
                    renderPairsTable();
                    updateStatusDisplay();
                    
                    // 短暂延迟，避免请求过快
                    if (i + batchSize < monitoredPairs.length) {
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                    
                } catch (error) {
                    console.error('批量加载数据失败:', error);
                    showError(`加载部分数据失败: ${batch.join(', ')}`);
                }
            }
            
            // 如果没有WebSocket连接，则标记为已连接
            if (!wsConnection || wsConnection.readyState !== WebSocket.OPEN) {
                updateConnectionStatus('connected', '数据已加载');
            }
        }
        
        // 从备用数据源加载交易对数据
        async function loadPairDataFromAlternative(pair) {
            try {
                // 尝试使用CoinGecko API
                const coinId = getCoinGeckoId(pair);
                if (coinId) {
                    const response = await fetchWithTimeout(
                        `${DATA_SOURCES.COINGECKO}/simple/price?ids=${coinId}&vs_currencies=usd&include_24hr_change=true`,
                        { timeout: 5000 }
                    );
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data[coinId]) {
                            const coinData = data[coinId];
                            
                            priceData[pair] = {
                                symbol: pair,
                                price: coinData.usd.toFixed(4),
                                change24h: coinData.usd_24h_change ? coinData.usd_24h_change.toFixed(2) : '0.00',
                                timestamp: new Date().getTime()
                            };
                            
                            return;
                        }
                    }
                }
                
                // 如果CoinGecko失败，尝试使用第三方代理
                try {
                    const response = await fetchWithTimeout(
                        `https://api.allorigins.win/raw?url=${encodeURIComponent(`https://api.binance.com/api/v3/ticker/24hr?symbol=${pair}`)}`,
                        { timeout: 5000 }
                    );
                    
                    if (response.ok) {
                        const data = await response.json();
                        
                        priceData[pair] = {
                            symbol: pair,
                            price: parseFloat(data.lastPrice).toFixed(4),
                            high: parseFloat(data.highPrice).toFixed(4),
                            low: parseFloat(data.lowPrice).toFixed(4),
                            change24h: parseFloat(data.priceChangePercent).toFixed(2),
                            volume: formatVolume(parseFloat(data.volume)),
                            quoteVolume: formatVolume(parseFloat(data.quoteVolume)),
                            timestamp: new Date().getTime()
                        };
                        
                        return;
                    }
                } catch (proxyError) {
                    console.error('代理请求失败:', proxyError);
                }
                
                // 所有备用方案都失败，使用模拟数据
                console.warn(`所有数据源失败，为 ${pair} 使用模拟数据`);
                generateMockData(pair);
                
            } catch (error) {
                console.error(`加载 ${pair} 数据失败:`, error);
                generateMockData(pair);
            }
        }
        
        // 获取CoinGecko币种ID
        function getCoinGeckoId(pair) {
            const coinMap = {
                'BTCUSDT': 'bitcoin',
                'ETHUSDT': 'ethereum',
                'BNBUSDT': 'binancecoin',
                'SOLUSDT': 'solana',
                'ADAUSDT': 'cardano',
                'XRPUSDT': 'ripple',
                'DOTUSDT': 'polkadot',
                'DOGEUSDT': 'dogecoin',
                'AVAXUSDT': 'avalanche-2',
                'MATICUSDT': 'matic-network'
            };
            
            // 提取币种部分（假设交易对格式为XXXUSDT）
            const symbol = pair.replace('USDT', '').toLowerCase();
            
            // 先在映射表中查找
            if (coinMap[pair]) {
                return coinMap[pair];
            }
            
            // 否则尝试通用映射
            return symbol;
        }
        
        // 生成模拟数据（备用方案）
        function generateMockData(pair) {
            const basePrice = 100 + Math.random() * 1000;
            const change24h = (Math.random() - 0.5) * 15;
            
            priceData[pair] = {
                symbol: pair,
                price: basePrice.toFixed(4),
                change24h: change24h.toFixed(2),
                volume: formatVolume(Math.random() * 1000000),
                timestamp: new Date().getTime()
            };
        }
        
        // 渲染交易对表格
        function renderPairsTable() {
            const tableBody = document.getElementById('pairs-table-body');
            
            // 如果没有交易对
            if (monitoredPairs.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 30px; color: #94a3b8;">
                            暂无交易对，请添加交易对开始监控
                        </td>
                    </tr>
                `;
                document.getElementById('total-pairs').textContent = '0';
                return;
            }
            
            tableBody.innerHTML = '';
            
            monitoredPairs.forEach(pair => {
                const data = priceData[pair] || { 
                    price: '--', 
                    change24h: 0
                };
                
                const changeClass = data.change24h >= 0 ? 'change-positive' : 'change-negative';
                const changeSign = data.change24h >= 0 ? '+' : '';
                const changeText = data.change24h !== 0 && data.change24h !== '--' ? 
                    `${changeSign}${data.change24h}%` : '0.00%';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${pair}</strong></td>
                    <td>${data.price}</td>
                    <td class="${changeClass}">${changeText}</td>
                    <td>
                        <span class="indicator ${getPairStatus(pair)}">
                            ${getPairStatusText(pair)}
                        </span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn btn-danger remove-pair-btn" data-pair="${pair}">
                                <i class="fas fa-trash"></i> 删除
                            </button>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // 更新交易对计数
            document.getElementById('total-pairs').textContent = monitoredPairs.length;
            
            // 绑定删除按钮事件
            document.querySelectorAll('.remove-pair-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const pair = this.getAttribute('data-pair');
                    removePair(pair);
                });
            });
        }
        
        // 渲染异动表格
        function renderAlertsTable() {
            const tableBody = document.getElementById('alerts-table-body');
            
            // 过滤当前时间周期的异动
            const filteredAlerts = activeTimeframe === '1m' 
                ? alertData 
                : alertData.filter(alert => alert.timeframe === activeTimeframe);
            
            // 按时间排序（最新的在前）
            const sortedAlerts = filteredAlerts.sort((a, b) => b.timestamp - a.timestamp);
            
            // 显示最近的15个异动
            const displayAlerts = sortedAlerts.slice(0, 15);
            
            if (displayAlerts.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 30px; color: #94a3b8;">
                            当前时间段暂无异动
                        </td>
                    </tr>
                `;
            } else {
                tableBody.innerHTML = '';
                
                displayAlerts.forEach(alert => {
                    const changeClass = alert.priceChange >= 0 ? 'change-positive' : 'change-negative';
                    const changeSign = alert.priceChange >= 0 ? '+' : '';
                    const strengthText = getStrengthText(alert.strength);
                    const strengthClass = getStrengthClass(alert.strength);
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><strong>${alert.pair}</strong></td>
                        <td>${alert.timeframe}</td>
                        <td class="${changeClass}">${changeSign}${alert.priceChange}%</td>
                        <td>
                            <span class="indicator ${alert.type}">
                                ${getAlertTypeText(alert.type)}
                            </span>
                        </td>
                        <td>
                            <span class="alert-badge ${strengthClass}">${strengthText}</span>
                        </td>
                        <td>${alert.time || new Date(alert.timestamp).toLocaleTimeString('zh-CN', {hour12: false})}</td>
                    `;
                    tableBody.appendChild(row);
                });
            }
            
            // 更新活跃异动计数
            const activeAlerts = alertData.filter(alert => 
                alert.timestamp > Date.now() - 3600000 // 1小时内的异动
            ).length;
            
            document.getElementById('active-alerts').textContent = activeAlerts;
        }
        
        // 获取异动类型文本
        function getAlertTypeText(type) {
            const typeMap = {
                'accumulation': '吸筹',
                'distribution': '砸盘',
                'volume-spike': '放量',
                'buy': '买入信号',
                'sell': '卖出信号',
                'neutral': '中性'
            };
            return typeMap[type] || type;
        }
        
        // 获取强度文本
        function getStrengthText(strength) {
            if (strength >= 0.8) return '高';
            if (strength >= 0.5) return '中';
            return '低';
        }
        
        // 获取强度类名
        function getStrengthClass(strength) {
            if (strength >= 0.8) return 'high';
            if (strength >= 0.5) return 'medium';
            return 'low';
        }
        
        // 获取交易对状态
        function getPairStatus(pair) {
            const pairAlerts = alertData.filter(alert => alert.pair === pair);
            if (pairAlerts.length === 0) return 'neutral';
            
            const hasBuy = pairAlerts.some(alert => alert.type === 'buy');
            const hasSell = pairAlerts.some(alert => alert.type === 'sell');
            
            if (hasBuy && !hasSell) return 'buy';
            if (hasSell && !hasBuy) return 'sell';
            return 'neutral';
        }
        
        // 获取交易对状态文本
        function getPairStatusText(pair) {
            const status = getPairStatus(pair);
            switch(status) {
                case 'buy': return '买入信号';
                case 'sell': return '卖出信号';
                default: return '观望中';
            }
        }
        
        // 更新交易建议
        function updateSuggestions() {
            const suggestionsContent = document.getElementById('suggestions-content');
            
            if (monitoredPairs.length === 0) {
                suggestionsContent.innerHTML = `
                    <div class="suggestion-item">
                        <strong>暂无交易对</strong> 请添加交易对以获取建议。
                    </div>
                `;
                return;
            }
            
            let suggestionsHTML = '';
            
            // 分析每个交易对
            monitoredPairs.forEach(pair => {
                const data = priceData[pair];
                if (!data) {
                    suggestionsHTML += `
                        <div class="suggestion-item">
                            <strong>${pair}</strong>
                            <div style="margin-top: 8px; color: #94a3b8;">
                                等待数据加载...
                            </div>
                        </div>
                    `;
                    return;
                }
                
                const change = parseFloat(data.change24h) || 0;
                const alerts = alertData.filter(a => a.pair === pair);
                
                let suggestion = '';
                let confidence = '低';
                let signal = 'neutral';
                
                // 生成建议逻辑
                if (change > 5 && alerts.some(a => a.type === 'buy')) {
                    suggestion = `强势上涨中，考虑逢低买入`;
                    confidence = '高';
                    signal = 'buy';
                } else if (change < -5 && alerts.some(a => a.type === 'sell')) {
                    suggestion = `大幅下跌，建议观望或止损`;
                    confidence = '高';
                    signal = 'sell';
                } else if (change > 2) {
                    suggestion = `温和上涨，可考虑轻仓参与`;
                    confidence = '中';
                    signal = 'buy';
                } else if (change < -2) {
                    suggestion = `回调中，等待企稳信号`;
                    confidence = '中';
                    signal = 'sell';
                } else if (Math.abs(change) < 1) {
                    suggestion = `横盘整理，等待方向选择`;
                    confidence = '低';
                    signal = 'neutral';
                } else {
                    suggestion = `震荡行情，建议观望`;
                    confidence = '低';
                    signal = 'neutral';
                }
                
                // 技术指标建议
                const rsi = calculateRSI(change);
                let indicatorSuggestion = '';
                
                if (rsi > 70) {
                    indicatorSuggestion = `RSI超买(${rsi.toFixed(1)})，注意回调风险`;
                } else if (rsi < 30) {
                    indicatorSuggestion = `RSI超卖(${rsi.toFixed(1)})，可能有反弹机会`;
                } else {
                    indicatorSuggestion = `RSI中性(${rsi.toFixed(1)})`;
                }
                
                suggestionsHTML += `
                    <div class="suggestion-item">
                        <strong>${pair}</strong> 
                        <span class="indicator ${signal}" style="margin-left: 10px;">
                            ${signal === 'buy' ? '买入' : signal === 'sell' ? '卖出' : '观望'}
                        </span>
                        <span class="alert-badge ${confidence === '高' ? 'high' : confidence === '中' ? 'medium' : 'low'}" style="margin-left: 10px;">
                            ${confidence}信心
                        </span>
                        <div style="margin-top: 8px; font-size: 0.95rem;">
                            ${suggestion} | ${indicatorSuggestion}
                        </div>
                        <div style="margin-top: 5px; font-size: 0.85rem; color: #94a3b8;">
                            价格: ${data.price} | 24h变化: ${change >= 0 ? '+' : ''}${change.toFixed(2)}%
                        </div>
                    </div>
                `;
            });
            
            // 添加一般性建议
            suggestionsHTML += `
                <div class="suggestion-item">
                    <strong>一般交易建议</strong>
                    <div style="margin-top: 8px; font-size: 0.95rem;">
                        1. 设置止损：每次开单都应设置止损，建议2-5%<br>
                        2. 仓位管理：单笔交易不超过总资金的5%<br>
                        3. 趋势跟随：跟随主要趋势方向交易<br>
                        4. 风险管理：避免在重大新闻前后开大仓
                    </div>
                </div>
            `;
            
            suggestionsContent.innerHTML = suggestionsHTML;
        }
        
        // 计算RSI（基于价格变化）
        function calculateRSI(priceChange) {
            // 简化的RSI估算
            if (priceChange > 10) return 75;
            if (priceChange > 5) return 65;
            if (priceChange > 2) return 55;
            if (priceChange > 0) return 50;
            if (priceChange > -2) return 45;
            if (priceChange > -5) return 35;
            if (priceChange > -10) return 25;
            return 15;
        }
        
        // 更新状态显示
        function updateStatusDisplay() {
            updateLastUpdateTime();
        }
        
        // 更新连接状态
        function updateConnectionStatus(status, text) {
            const statusElement = document.getElementById('connection-status');
            statusElement.className = `websocket-status ${status}`;
            
            const icon = status === 'connected' ? 'fa-wifi' : 
                        status === 'connecting' ? 'fa-sync fa-spin' : 'fa-plug';
            
            statusElement.innerHTML = `<i class="fas ${icon}"></i> ${text}`;
        }
        
        // 更新最后更新时间
        function updateLastUpdateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('zh-CN', { 
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            document.getElementById('last-update-time').textContent = timeString;
        }
        
        // 启动更新计时器
        function startUpdateTimer() {
            // 定期更新建议和检查数据
            setInterval(() => {
                updateSuggestions();
                
                // 定期重新加载数据（如果WebSocket断开）
                if (!wsConnection || wsConnection.readyState !== WebSocket.OPEN) {
                    const now = Date.now();
                    const lastUpdate = Object.values(priceData)[0]?.timestamp || 0;
                    
                    // 如果数据超过60秒未更新，重新加载
                    if (now - lastUpdate > 60000) {
                        loadInitialData();
                    }
                }
            }, 30000); // 每30秒更新一次
        }
        
        // 格式化成交量
        function formatVolume(volume) {
            if (!volume || isNaN(volume)) return '--';
            
            if (volume >= 1e9) {
                return (volume / 1e9).toFixed(2) + 'B';
            } else if (volume >= 1e6) {
                return (volume / 1e6).toFixed(2) + 'M';
            } else if (volume >= 1e3) {
                return (volume / 1e3).toFixed(2) + 'K';
            } else {
                return volume.toFixed(2);
            }
        }
        
        // 显示通知
        function showNotification(message) {
            // 创建通知元素
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: var(--card-bg);
                color: var(--text-color);
                padding: 15px 20px;
                border-radius: 10px;
                border-left: 4px solid var(--primary-color);
                box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                z-index: 1000;
                max-width: 300px;
                animation: slideIn 0.3s ease;
            `;
            
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-info-circle" style="color: var(--primary-color);"></i>
                    <div>${message}</div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // 3秒后移除
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }
        
        // 显示错误
        function showError(message) {
            const errorContainer = document.getElementById('error-container');
            errorContainer.innerHTML = `
                <div class="error-message">
                    <i class="fas fa-exclamation-triangle"></i> ${message}
                </div>
            `;
        }
        
        // 清除错误
        function clearError() {
            const errorContainer = document.getElementById('error-container');
            errorContainer.innerHTML = '';
        }
        
        // 带超时的fetch
        async function fetchWithTimeout(url, options = {}) {
            const { timeout = 8000 } = options;
            
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), timeout);
            
            try {
                const response = await fetch(url, {
                    ...options,
                    signal: controller.signal
                });
                clearTimeout(id);
                return response;
            } catch (error) {
                clearTimeout(id);
                throw error;
            }
        }
        
        // 添加CSS动画
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', initPage);
    </script>
</body>
</html>
